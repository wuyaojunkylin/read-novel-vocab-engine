<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50篇小说背单词</title>
    <style>
        /* ========== 全局样式 ========== */
        /* 重置页面默认边距和内边距 */
        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .page-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 24px 32px 40px;
            box-sizing: border-box;
        }

        @media (max-width: 1024px) {
            .page-container {
                padding: 24px 24px 36px;
            }
        }

        @media (max-width: 768px) {
            .page-container {
                padding: 20px 16px 32px;
            }
        }

        /* 页面主体样式 - 苹果风格 */
        body {
            /* 字体：使用系统字体，自动适配不同操作系统 */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* 背景色：浅灰色 */
            background-color: #f9f9f9;
            /* 文字颜色：深灰色 */
            color: #333333;
            /* 行高：增加可读性 */
            line-height: 1.6;
            /* 移除固定宽度限制，让容器自适应 */
            margin: 0;
            padding: 0;
        }

        /* ========== 标题样式 ========== */
        /* 故事标题 (h1) 样式 */
        h1 {
            /* 字体大小：约 35-40px */
            font-size: 2.2rem;
            /* 字体粗细：加粗 */
            font-weight: 700;
            /* 文字颜色：接近黑色 */
            color: #111111;
            /* 底部间距 */
            margin-bottom: 30px;
        }

        /* 章节标题 (h2) 样式 - 用于"单词表"标题 */
        h2 {
            /* 字体大小：约 28-32px */
            font-size: 1.8rem;
            /* 字体粗细：中等加粗 */
            font-weight: 600;
            /* 文字颜色：接近黑色 */
            color: #111111;
            /* 顶部间距：与上面内容保持距离 */
            margin-top: 50px;
            /* 底部间距 */
            margin-bottom: 20px;
        }

        /* ========== 故事内容样式 ========== */
        /* 故事正文容器样式 */
        #story-content {
            /* 字体大小：约 17-18px，便于阅读 */
            font-size: 1.1rem;
            /* 行高：增加行间距，提高阅读舒适度 */
            line-height: 2;
        }

        /* 段落样式 */
        #story-content p {
            /* 段落间距 */
            margin-bottom: 1.5em;
            /* 段落首行缩进（所有段落统一缩进2个字符） */
            text-indent: 2em;
        }

        /* 单词高亮单元样式 - 用于标记需要学习的单词 */
        .word-unit {
            /* 背景色：淡黄色，突出显示单词 */
            background-color: #FFFFCC;
            /* 内边距：上下2px，左右4px */
            padding: 2px 4px;
            /* 圆角：4px */
            border-radius: 4px;
        }

        /* 英文单词样式 - 在 .word-unit 内部 */
        .english {
            /* 字体粗细：加粗显示英文单词 */
            font-weight: 600;
        }

        /* 释义样式 - 在 .word-unit 内部，用于显示 (adj. 形容词) 等 */
        .details {
            /* 文字颜色：灰色，作为辅助信息 */
            color: #666666;
        }

        /* ========== 单词表样式 ========== */
        /* 表格整体样式 */
        table {
            /* 宽度：占满容器 */
            width: 100%;
            /* 边框合并：相邻单元格边框合并为一条 */
            border-collapse: collapse;
            /* 背景色：白色 */
            background-color: #ffffff;
            /* 圆角：12px，苹果风格 */
            border-radius: 12px;
            /* 溢出隐藏：配合圆角使用 */
            overflow: hidden;
            /* 阴影：营造立体感 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* 表格单元格样式 */
        th, td {
            /* 内边距：12px，增加单元格空间感 */
            padding: 12px;
            /* 底部边框：浅灰色分隔线 */
            border-bottom: 1px solid #eee;
            /* 文字对齐：左对齐 */
            text-align: left;
        }

        /* 单词列固定宽度 */
        th:nth-child(1), td:nth-child(1) {
            min-width: 150px;
        }

        /* 音标列固定宽度 */
        th:nth-child(2), td:nth-child(2) {
            min-width: 200px;
        }

        /* 表头样式 */
        th {
            /* 背景色：浅灰色 */
            background-color: #f9f9f9;
            /* 字体粗细：加粗 */
            font-weight: 600;
            /* 文字颜色：接近黑色 */
            color: #111111;
        }

        /* 表格行悬停效果 */
        tr:hover {
            /* 悬停时背景色变为稍微深一点的灰色 */
            background-color: #fafafa;
        }

        /* 单词列样式 - 表格中显示单词的单元格 */
        .word-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            font-weight: 600;
            color: #2e9eb7;
        }

        .word-cell .word-text {
            font-size: 1rem;
        }

        .word-cell .phonetic {
            font-size: 0.85rem;
            color: #64748B;
            font-style: italic;
        }

        /* 音标列样式 - 表格中显示音标的单元格 */
        .phonetic-cell {
            /* 文字颜色：灰色 */
            color: #666666;
            /* 斜体：音标通常用斜体显示 */
            font-style: italic;
        }

        /* ========== 顶部导航栏样式 ========== */
        .top-navigation {
            /* 弹性布局：横向排列导航链接 */
            display: flex;
            /* 链接间距 */
            gap: 24px;
            /* 底部间距 */
            margin-bottom: 30px;
            /* 顶部内边距 */
            padding-top: 10px;
            /* 底部内边距 */
            padding-bottom: 10px;
            /* 底部边框：分隔导航和内容 */
            border-bottom: 1px solid #e5e5e5;
        }

        /* 导航链接样式 */
        .nav-link {
            /* 显示方式：弹性容器 */
            display: flex;
            /* 垂直居中对齐 */
            align-items: center;
            /* 图标与文字间距 */
            gap: 6px;
            /* 文本颜色 */
            color: #347474;
            /* 去除下划线 */
            text-decoration: none;
            /* 字体大小 */
            font-size: 1.05rem;
            /* 字体加粗 */
            font-weight: 500;
            /* 过渡效果 */
            transition: all 0.2s ease-in-out;
            /* 内容内边距 */
            padding: 6px 10px;
            /* 圆角 */
            border-radius: 6px;
            border: none;
            background: none;
            cursor: pointer;
        }

        /* 导航链接悬停效果 */
        .nav-link:hover {
            /* 悬停时颜色变深 */
            color: #285f5f;
            /* 悬停时背景色 */
            background-color: #e8f1f1;
        }

        /* 导航图标样式 */
        .nav-link svg {
            /* 图标宽度 */
            width: 16px;
            /* 图标高度 */
            height: 16px;
            /* 图标颜色：继承文字颜色 */
            fill: currentColor;
            /* 防止图标缩小 */
            flex-shrink: 0;
        }

        /* 响应式设计：小屏幕适配 */
        @media (max-width: 600px) {
            .top-navigation {
                /* 减小链接间距 */
                gap: 12px;
                /* 允许换行 */
                flex-wrap: wrap;
            }

            .nav-link {
                /* 调整字体大小 */
                font-size: 0.85rem;
                /* 减小内边距 */
                padding: 5px 8px;
            }

            .nav-link svg {
                /* 调整图标大小 */
                width: 14px;
                height: 14px;
            }
        }

        /* ========== 挖空模式样式 ========== */
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            width: 100%;
        }

        @media (max-width: 900px) {
            .mode-buttons {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        .mode-btn {
            padding: 12px 12px;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #ffffff;
            color: #2e9eb7;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            width: 100%;
            white-space: nowrap;
        }

        .mode-btn:hover {
            background-color: #f0f7ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .mode-btn.active {
            background-color: #2e9eb7;
            color: #ffffff;
        }

        /* Tooltip 样式 */
        .mode-btn {
            position: relative;
        }

        .mode-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background-color: rgba(0, 0, 0, 0.85);
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 100;
        }

        .mode-btn[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(2px);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.85);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 100;
        }

        .mode-btn[data-tooltip]:hover::after,
        .mode-btn[data-tooltip]:hover::before {
            opacity: 1;
        }

        .mode-btn[data-tooltip]:hover::after {
            transform: translateX(-50%) translateY(-12px);
        }

        /* Step 2 模式：隐藏中文释义 (details) - 只看英文想中文 */
        body.mode-step2 .word-unit .details {
            display: none;
        }

        /* Step 3 模式：隐藏英文单词 (english) - 只看中文想英文 */
        body.mode-step3 .word-unit .english {
            display: none;
        }

        /* Step 3 模式：中文释义加粗，使用和Step2英文单词相同的颜色（默认黑色） */
        body.mode-step3 .word-unit .details {
            font-weight: 700;
            color: #333333;
        }

        /* Step 1 模式：英文单词和中文释义的颜色设为深灰色并加粗 */
        body.mode-step1 .word-unit .english {
            color: #333333;
            font-weight: 700;
        }

        body.mode-step1 .word-unit .details {
            color: #333333;
            font-weight: 700;
        }

        /* 可点击提示样式 */
        .word-unit.collapsible {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .word-unit.collapsible:hover {
            background-color: #FFF6CC;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 单词高亮时的样式（临时显示被隐藏的部分） */
        /* 在 Step 2 模式下，点击后显示中文 */
        body.mode-step2 .word-unit.show-hidden .details {
            display: inline !important;
            color: #24a1a1;
            font-weight: 700;
        }

        /* 在 Step 3 模式下，点击后显示英文 */
        body.mode-step3 .word-unit.show-hidden .english {
            display: inline !important;
            color: #24a1a1;
            font-weight: 700;
        }

        /* 点击后的背景颜色和动画 */
        .word-unit.show-hidden {
            background-color: #E6F3FF;
            animation: wordClick 0.3s ease-in-out;
        }

        @keyframes wordClick {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Step 4 模式：隐藏故事内容，只显示单词表 */
        body.mode-step4 #story-content {
            display: none;
        }

        body.mode-step4 #vocabulary-title {
            display: block !important;
        }

        body.mode-step4 #vocabulary-table {
            display: block !important;
        }

        /* 本故事生词本模式：隐藏故事内容和完整单词表 */
        body.mode-difficult-words #story-content {
            display: none;
        }

        body.mode-difficult-words #vocabulary-title {
            display: none !important;
        }

        body.mode-difficult-words #vocabulary-table {
            display: none !important;
        }

        body.mode-difficult-words #current-story-difficult-words-section {
            display: block !important;
        }

        /* 其他模式下隐藏单词表和生词本 */
        body:not(.mode-step4) #vocabulary-title,
        body:not(.mode-step4) #vocabulary-table {
            display: none !important;
        }

        body:not(.mode-difficult-words) #current-story-difficult-words-section {
            display: none !important;
        }

        /* ========== 学习进度显示样式 ========== */
        .progress-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333333;
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2e9eb7;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background-color: #2e9eb7;
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }

        .progress-steps {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-align: center;
            padding: 10px 12px;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: all 0.2s ease-in-out;
        }

        .progress-step-extra {
            font-size: 0.75rem;
            color: #94A3B8;
            font-weight: 500;
        }

        .progress-step.completed {
            background-color: #e6f7ff;
        }

        .progress-step-label {
            font-size: 0.8rem;
            color: #64748B;
            font-weight: 600;
        }

        .progress-step-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #2e9eb7;
        }

        .progress-step.completed .progress-step-value {
            color: #2e9eb7;
        }

        /* 单词点击统计 */
        .word-click-stats {
            font-size: 0.85rem;
            color: #666666;
            margin-top: 5px;
            text-align: center;
        }

        .word-click-stats .current {
            color: #2e9eb7;
            font-weight: 600;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            .progress-steps {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== 故事导航样式 ========== */
        .story-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 50px;
            margin-bottom: 30px;
            padding: 20px 0;
            border-top: 1px solid #e0e0e0;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            border: 2px solid #2e9eb7;
            background-color: #ffffff;
            color: #2e9eb7;
            transition: all 0.2s ease-in-out;
            min-height: 53px; /* 原80px的2/3，约53px */
        }

        .nav-btn:hover {
            background-color: #2e9eb7;
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 158, 183, 0.3);
        }

        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #cccccc;
            color: #999999;
        }

        .nav-btn.disabled:hover {
            background-color: #ffffff;
            color: #999999;
            transform: none;
            box-shadow: none;
        }

        .nav-label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .nav-title {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* 上一篇按钮左对齐 */
        .nav-btn.prev-btn {
            text-align: left;
        }

        /* 下一篇按钮右对齐 */
        .nav-btn.next-btn {
            text-align: right;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            .story-navigation {
                flex-direction: column;
                gap: 15px;
            }

            .nav-btn {
                width: 100%;
                min-height: 47px; /* 原70px的2/3，约47px */
            }

            .nav-title {
                font-size: 0.9rem;
            }
        }

        /* ========== 本故事生词本样式 ========== */
        #current-story-difficult-words-section {
            display: none;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        #current-story-difficult-words-section h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111111;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2e9eb7;
        }

        .current-story-difficult-words-table table {
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
        }

        .current-story-difficult-words-table th {
            background-color: #f9f9f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #111111;
            border-bottom: 2px solid #e0e0e0;
        }

        .current-story-difficult-words-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .current-story-difficult-words-table tr:hover {
            background-color: #fafafa;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999999;
        }

        .play-audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            border-radius: 6px;
            color: #94A3B8;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .play-audio-btn:hover {
            background-color: #F1F5F9;
            color: #475569;
            transform: scale(1.05);
        }

        .play-audio-btn:active {
            transform: scale(0.95);
            color: #1F2937;
        }

        .play-audio-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.6;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.2s ease-in-out, fill 0.2s ease-in-out;
        }

        /* 收藏按钮样式 */
        .star-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: #94A3B8;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }

        .star-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.6;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.2s ease-in-out, fill 0.2s ease-in-out;
        }

        .star-btn:hover {
            background-color: #F1F5F9;
            color: #475569;
            transform: scale(1.05);
        }

        .star-btn:active {
            transform: scale(0.95);
        }

        .star-btn.starred {
            color: #FBBF24;
            background-color: #FFFBEB;
        }

        .star-btn.starred svg {
            fill: currentColor;
        }

        .star-btn.starred:hover {
            color: #FACC15;
            background-color: #FEF3C7;
        }
        .difficult-remove-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            border-radius: 6px;
            color: #94A3B8;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .difficult-remove-btn:hover {
            background-color: #F1F5F9;
            color: #475569;
            transform: scale(1.05);
        }

        .difficult-remove-btn:active {
            transform: scale(0.95);
            color: #1F2937;
        }

        .difficult-remove-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.6;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.2s ease-in-out, fill 0.2s ease-in-out;
        }

        /* ===== 版权页脚样式 ===== */
        .site-footer {
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 2rem; /* 确保和页面内容有一定间距 */
            border-top: 1px solid #eee; /* 一条细微的分割线 */
        }
        .site-footer p {
            margin: 0;
            font-size: 0.85em; /* 字体小一点 */
            color: #999; /* 颜色淡一点，不抢眼 */
        }
    </style>
    <script type="module" src="/src/js/main.js"></script>
</head>
<body class="mode-step1">
    <div class="page-container">
    <!-- ========== HTML 结构 ========== -->
    <!-- 顶部导航栏 -->
    <nav class="top-navigation">
        <a href="index.html" class="nav-link">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
            </svg>
            故事列表
        </a>
        <a href="words.html" class="nav-link">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/>
            </svg>
            我的生词本
        </a>
        <a href="stats.html" class="nav-link">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3v18h18v-2H5V3H3zm4 12h2v4H7v-4zm4-4h2v8h-2v-8zm4-4h2v12h-2V7z"/>
            </svg>
            学习统计
        </a>
        <a href="settings.html" class="nav-link">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.34.27.76.42 1.2.42H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            设置
        </a>
        <a href="guide.html" class="nav-link">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.8"/>
                <line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <circle cx="12" cy="8" r="1" fill="currentColor"/>
            </svg>
            使用说明
        </a>
    </nav>
    
    <!-- 故事标题 - 通过 JavaScript 动态更新 -->
    <h1 id="story-title">加载中...</h1>
    
    <!-- 学习进度卡片 -->
    <div class="progress-card" id="progress-card" style="display: none;">
        <div class="progress-header">
            <div class="progress-title">学习进度</div>
            <div class="progress-percentage" id="progress-percentage">0%</div>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
        </div>
        <div class="progress-steps" id="progress-steps">
            <!-- 各步骤进度将通过 JavaScript 动态生成 -->
        </div>
    </div>
    
    <!-- 挖空模式按钮 -->
    <div class="mode-buttons" id="mode-buttons">
        <button class="mode-btn active" id="btn-step1" data-tooltip="完整阅读故事，理解上下文，熟悉单词用法">Step 1: 阅读模式</button>
        <button class="mode-btn" id="btn-step2" data-tooltip="隐藏中文释义，点击单词显示答案">Step 2: 中文填空</button>
        <button class="mode-btn" id="btn-step3" data-tooltip="隐藏英文单词，点击显示，测试记忆">Step 3: 英文填空</button>
        <button class="mode-btn" id="btn-step4" data-tooltip="查看所有单词列表，支持语音播放和收藏">Step 4: 单词表</button>
        <button class="mode-btn" id="btn-difficult-words" data-tooltip="查看你在本故事中收藏的生词">本故事生词本</button>
    </div>
    
    <!-- 本故事生词本区域 -->
    <div id="current-story-difficult-words-section">
        <h3>本故事生词本</h3>
        <div id="current-story-difficult-words-container" class="current-story-difficult-words-table">
            <!-- 生词表将通过 JavaScript 动态生成 -->
        </div>
    </div>
    
    <!-- 故事内容容器 - 通过 JavaScript 动态加载并插入内容 -->
    <div id="story-content">
        <!-- 故事内容将通过 JavaScript 动态加载 -->
    </div>
    
    <!-- 单词表标题 - 初始隐藏，当有单词数据时显示 -->
    <h2 id="vocabulary-title" style="display: none;">单词表</h2>
    
    <!-- 单词表容器 - 初始隐藏，通过 JavaScript 动态生成表格 -->
    <div id="vocabulary-table" style="display: none;">
        <!-- 单词表将通过 JavaScript 动态加载 -->
    </div>

    <!-- 故事导航按钮 -->
    <div class="story-navigation" id="story-navigation" style="display: none;">
        <a href="#" id="prev-story-btn" class="nav-btn prev-btn">
            <span class="nav-label">← 上一篇</span>
            <span class="nav-title" id="prev-story-title"></span>
        </a>
        <a href="#" id="next-story-btn" class="nav-btn next-btn">
            <span class="nav-label">下一篇 →</span>
            <span class="nav-title" id="next-story-title"></span>
        </a>
    </div>
    </div>

    <script>
        const storyId = getStoryId();
        let allStories = [];
        let currentStory = null;
        let currentMode = 'step1';
        let totalClickableWords = 0;
        let reviewOverlayVisible = false;

        const VOICE_BLACKLIST = ['Albert','Bad News','Bahh','Bells','Boing','Bubbles','Cellos','Deranged','Good News','Jester','Organ','Superstar','Trinoids','Whisper','Wobble','Zarvox'];
        const VOICE_PRIORITY_KEYWORDS = ['Samantha','Alex','Microsoft Zira','Google US English','Google UK English Female','Karen','Moira','Tessa','Premium','Natural'];
        let cachedVoices = [];
        let speechEngineWarmed = false;

        if ('speechSynthesis' in window) {
            cachedVoices = window.speechSynthesis.getVoices();
            if (cachedVoices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    cachedVoices = window.speechSynthesis.getVoices();
                    if (!speechEngineWarmed && cachedVoices.length) {
                        warmupSpeechEngine();
                    }
                };
            } else {
                warmupSpeechEngine();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const startPage = () => {
                if (window.setTimingContext) {
                    window.setTimingContext({ storyId, mode: 'step1' });
                } else {
                    window.currentTimingContext = { storyId, mode: 'step1' };
                }
                if (typeof window.initializeLearningTimer === 'function') {
                    window.initializeLearningTimer();
                }
                initStoryPage();
            };

            if (window.dataManager && window.dataManager.appData && window.dataManager.appData.length > 0) {
                startPage();
            } else {
                document.addEventListener('appDataReady', () => {
                    startPage();
                }, { once: true });
            }
        });

        async function initStoryPage() {
            try {
                showLoadingState(true);
                allStories = await getAllStories();
                currentStory = allStories.find(story => story.id === storyId);

                if (!currentStory) {
                    renderErrorState('未找到对应的故事，请返回故事列表');
                    return;
                }

                renderStoryTitle(currentStory);
                renderStoryContent(currentStory);
                renderVocabularyTable(currentStory);
                renderCurrentStoryDifficultWords();
                renderStoryNavigation(allStories, storyId);
                initModeButtons();
                initProgressListeners();
                initVocabularyProgressWatcher();
                handleScrollProgress();
                switchMode('step1', { skipRecord: true });
                recordModeUsage(storyId, 'step1');
                initializeLearningTimer();
                renderProgressCard();
                showLoadingState(false);
            } catch (error) {
                console.error('加载故事失败:', error);
                renderErrorState('加载故事内容时出错，请刷新页面重试');
            }
        }

        function showLoadingState(isLoading) {
            const titleEl = document.getElementById('story-title');
            if (!titleEl) return;
            titleEl.textContent = isLoading ? '加载中...' : (currentStory?.title || storyId);
        }

        function renderErrorState(message) {
            const titleEl = document.getElementById('story-title');
            const contentEl = document.getElementById('story-content');
            showLoadingState(false);
            if (titleEl) titleEl.textContent = '加载失败';
            if (contentEl) contentEl.innerHTML = `<div class="empty-state">${message}</div>`;
        }

        function renderStoryTitle(story) {
            const titleEl = document.getElementById('story-title');
            if (titleEl) {
                titleEl.textContent = story.title || story.id;
            }
        }

        function renderStoryContent(story) {
            const contentEl = document.getElementById('story-content');
            if (!contentEl) return;

            const paragraphs = story.content.split(/\n\s*\n/).filter(Boolean);
            const firstParagraph = paragraphs[0] || '';
            const normalizedTitle = (story.title || storyId || '').trim().replace(/[:：]+/g, ':').toLowerCase();
            const normalizedParagraph = firstParagraph.trim().replace(/[:：]+/g, ':').toLowerCase();

            const filteredParagraphs = normalizedParagraph.startsWith(normalizedTitle)
                ? paragraphs.slice(1)
                : paragraphs;

            let html = '';
            let renderIndex = 0;

            filteredParagraphs.forEach(paragraph => {
                const processed = processStoryParagraph(paragraph, renderIndex);
                renderIndex += processed.count;
                html += `<p>${processed.html}</p>`;
            });

            contentEl.innerHTML = html;
            totalClickableWords = contentEl.querySelectorAll('.word-unit').length;
            setupWordInteractions(contentEl);
            initializeWordProgressState();
            applyStoredWordHighlights(currentMode);
        }

        function processStoryParagraph(text, startIndex = 0) {
            let index = startIndex;
            const html = text.replace(/\*\*(.*?)\((.*?)\)\*\*/g, (match, word, details) => {
                const wordId = `${storyId}_word_${index++}`;
                return `<span class="word-unit collapsible" data-word-id="${wordId}" data-word="${escapeHtml(word)}" data-details="${escapeHtml(details)}"><span class="english">${escapeHtml(word)}</span><span class="details">(${escapeHtml(details)})</span></span>`;
            });
            return { html, count: index - startIndex };
        }

        function escapeHtml(input) {
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function setupWordInteractions(container) {
            const wordUnits = container.querySelectorAll('.word-unit');
            wordUnits.forEach(unit => {
                unit.addEventListener('click', () => handleWordClick(unit));
            });
        }

        function handleWordClick(wordElement) {
            if (currentMode !== 'step2' && currentMode !== 'step3') {
                return;
            }

            wordElement.classList.toggle('show-hidden');

            const wordId = wordElement.dataset.wordId;
            if (wordId) {
                const datasetKey = `${currentMode}Clicked`;
                if (!wordElement.dataset[datasetKey]) {
                    wordElement.dataset[datasetKey] = 'true';
                }
                recordWordClick(storyId, currentMode, wordId, Math.max(totalClickableWords, 1));
                renderProgressCard();
            }
        }

        function initModeButtons() {
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const mode = button.id.replace('btn-', '');
                    if (mode) {
                        switchMode(mode);
                    }
                });
            });
        }

        function switchMode(mode, options = {}) {
            if (!['step1', 'step2', 'step3', 'step4', 'difficult-words'].includes(mode)) {
                return;
            }

            const previousMode = (window.currentTimingContext?.mode) || currentMode;
            if (window.setLearningMode) {
                window.setLearningMode(mode);
            } else if (window.currentTimingContext) {
                window.currentTimingContext.mode = mode;
            }
            if (typeof window.tickLearningTime === 'function') {
                window.tickLearningTime();
            }
            if (previousMode) {
                if (typeof window.flushLearningBuffer === 'function') {
                    window.flushLearningBuffer(true, previousMode);
                }
                if (window.resetLearningAccumulator) {
                    window.resetLearningAccumulator();
                }
            }

            currentMode = mode;

            const body = document.body;
            body.classList.remove('mode-step1', 'mode-step2', 'mode-step3', 'mode-step4', 'mode-difficult-words');
            
            // 清除所有单词的显示状态，确保 step2 和 step3 独立
            document.querySelectorAll('.word-unit.show-hidden').forEach(el => {
                el.classList.remove('show-hidden');
            });
            
            if (mode === 'difficult-words') {
                body.classList.add('mode-difficult-words');
                showCurrentStoryDifficultWordsOnly();
            } else {
                body.classList.add(`mode-${mode}`);
                applyStoredWordHighlights(mode);
            }

            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.getElementById(`btn-${mode}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            if (typeof window.startLearningInterval === 'function') {
                window.startLearningInterval();
            }

            if (!options.skipRecord && mode !== 'difficult-words') {
                recordModeUsage(storyId, mode);
            }

            // Step 4 的进度更新由 handleScrollProgress 处理，不在这里直接设置
        }

        function showCurrentStoryDifficultWordsOnly() {
            // 重新渲染本故事生词本，确保数据最新
            renderCurrentStoryDifficultWords();
            
            const section = document.getElementById('current-story-difficult-words-section');
            if (section) {
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function renderVocabularyTable(story) {
            const tableContainer = document.getElementById('vocabulary-table');
            const titleEl = document.getElementById('vocabulary-title');
            if (!tableContainer || !titleEl) return;

            const words = story.vocabulary || [];
            if (!words.length) {
                tableContainer.innerHTML = '<div class="empty-state">此故事暂无单词表。</div>';
                return;
            }

            const difficultWords = getDifficultWords();
            const htmlRows = words.map(({ word, meaning, phonetic }, index) => {
                const isStarred = difficultWords.some(item => item.word === word && item.meaning === meaning);
                return `
                    <tr>
                        <td class="word-cell">
                            <span class="word-text">${escapeHtml(word)}</span>
                        </td>
                        <td class="phonetic-cell">${phonetic ? escapeHtml(phonetic) : ''}</td>
                        <td>${escapeHtml(meaning)}</td>
                        <td class="table-actions">
                            <button class="play-audio-btn" data-word="${escapeHtml(word)}" title="播放发音">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 9v6h3l4 4V5L8 9H5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M16 9.5a3.5 3.5 0 0 1 0 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M18.5 8a6 6 0 0 1 0 8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </button>
                            <button class="star-btn ${isStarred ? 'starred' : ''}" data-word="${escapeHtml(word)}" data-meaning="${escapeHtml(meaning)}" data-phonetic="${escapeHtml(phonetic || '')}">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 4.25 14.27 8.85l5.08.74-3.67 3.58.87 5.05L12 15.52 7.45 18.22l.87-5.05-3.67-3.58 5.08-.74L12 4.25Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            titleEl.style.display = 'none';
            tableContainer.innerHTML = `
                <table class="vocabulary-table">
                    <thead>
                        <tr>
                            <th>单词</th>
                            <th>音标</th>
                            <th>释义</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>${htmlRows}</tbody>
                </table>
            `;

            tableContainer.querySelectorAll('.play-audio-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    event.stopPropagation();
                    speakWord(btn.dataset.word);
                });
            });

            tableContainer.querySelectorAll('.star-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    event.stopPropagation();
                    toggleWordStar(btn);
                });
            });
        }

        function toggleWordStar(button) {
            const word = button.dataset.word;
            const meaning = button.dataset.meaning;
            const phonetic = button.dataset.phonetic;

            if (button.classList.contains('starred')) {
                if (removeDifficultWord(word, meaning)) {
                    button.classList.remove('starred');
                    renderCurrentStoryDifficultWords();
                }
            } else {
                if (addDifficultWord(word, phonetic, meaning, storyId)) {
                    button.classList.add('starred');
                    renderCurrentStoryDifficultWords();
                }
            }
        }

        function renderCurrentStoryDifficultWords() {
            const container = document.getElementById('current-story-difficult-words-container');
            if (!container) return;

            const difficultWords = getDifficultWords().filter(item => item.storyId === storyId);
            if (!difficultWords.length) {
                container.innerHTML = '<div class="empty-state">暂无收藏的生词，点击单词表中的星标按钮可以收藏生词。</div>';
                return;
            }

            const rows = difficultWords.map(item => `
                <tr>
                    <td class="word-cell">${escapeHtml(item.word)}</td>
                    <td class="phonetic-cell">${escapeHtml(item.phonetic || '')}</td>
                    <td>${escapeHtml(item.meaning)}</td>
                    <td class="action-cell">
                        <button class="play-audio-btn" data-word="${escapeHtml(item.word)}" title="播放发音">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 9v6h3l4 4V5L8 9H5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M16 9.5a3.5 3.5 0 0 1 0 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M18.5 8a6 6 0 0 1 0 8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </button>
                        <button class="difficult-remove-btn" data-word="${escapeHtml(item.word)}" data-meaning="${escapeHtml(item.meaning)}" title="移除生词">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <table class="current-story-difficult-words-table">
                    <thead>
                        <tr>
                            <th>单词</th>
                            <th>音标</th>
                            <th>释义</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

            container.querySelectorAll('.play-audio-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    event.stopPropagation();
                    speakWord(btn.dataset.word);
                });
            });

            container.querySelectorAll('.difficult-remove-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (removeDifficultWord(btn.dataset.word, btn.dataset.meaning)) {
                        renderCurrentStoryDifficultWords();
                        reSyncVocabularyStar(btn.dataset.word, btn.dataset.meaning, false);
                    }
                });
            });
        }

        function reSyncVocabularyStar(word, meaning, isStarred) {
            document.querySelectorAll('#vocabulary-table .star-btn').forEach(btn => {
                if (btn.dataset.word === word && btn.dataset.meaning === meaning) {
                    btn.classList.toggle('starred', isStarred);
                }
            });
        }

        function renderStoryNavigation(stories, currentId) {
            const navigation = document.getElementById('story-navigation');
            const prevBtn = document.getElementById('prev-story-btn');
            const nextBtn = document.getElementById('next-story-btn');
            const prevTitle = document.getElementById('prev-story-title');
            const nextTitle = document.getElementById('next-story-title');

            if (!navigation || !prevBtn || !nextBtn) return;

            const currentIndex = stories.findIndex(story => story.id === currentId);
            const prevStory = currentIndex > 0 ? stories[currentIndex - 1] : null;
            const nextStory = currentIndex < stories.length - 1 ? stories[currentIndex + 1] : null;

            if (prevStory) {
                prevBtn.href = `story.html?id=${encodeURIComponent(prevStory.id)}`;
                prevBtn.style.visibility = 'visible';
                if (prevTitle) prevTitle.textContent = prevStory.title || prevStory.id;
            } else {
                prevBtn.style.visibility = 'hidden';
            }

            if (nextStory) {
                nextBtn.href = `story.html?id=${encodeURIComponent(nextStory.id)}`;
                nextBtn.style.visibility = 'visible';
                if (nextTitle) nextTitle.textContent = nextStory.title || nextStory.id;
            } else {
                nextBtn.style.visibility = 'hidden';
            }

            navigation.style.display = 'flex';
        }

        function initProgressListeners() {
            window.addEventListener('scroll', handleScrollProgress);
            window.addEventListener('resize', handleScrollProgress);
            window.addEventListener('progressUpdated', event => {
                if (event.detail?.storyId === storyId) {
                    renderProgressCard();
                }
            });
        }

        function initVocabularyProgressWatcher() {
            // 使用 IntersectionObserver 监听单词表底部，只有当底部可见时才更新进度
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // 只有当单词表底部可见时，才更新进度
                        const before = getDetailedProgress()[storyId]?.step4 || 0;
                        updateStep4Progress(storyId, 1);
                        const after = getDetailedProgress()[storyId]?.step4 || 0;
                        if (after > before) {
                            renderProgressCard();
                        }
                    }
                });
            }, { threshold: 0.1 });

            const table = document.getElementById('vocabulary-table');
            if (table) {
                // 创建一个底部标记元素，用于检测是否滚动到底部
                const bottomMarker = document.createElement('div');
                bottomMarker.style.height = '1px';
                bottomMarker.style.position = 'absolute';
                bottomMarker.style.bottom = '0';
                bottomMarker.style.width = '100%';
                bottomMarker.style.pointerEvents = 'none';
                table.style.position = 'relative';
                table.appendChild(bottomMarker);
                observer.observe(bottomMarker);
            }
        }

        function handleScrollProgress() {
            const body = document.body;
            const isStep4 = body.classList.contains('mode-step4');
            
            if (isStep4) {
                // Step 4 模式：检查单词表是否滚动到底部
                const vocabularyTable = document.getElementById('vocabulary-table');
                if (vocabularyTable) {
                    const rect = vocabularyTable.getBoundingClientRect();
                    // 当单词表底部接近或超过视窗底部时，认为已滚动到底部
                    if (rect.bottom - window.innerHeight <= 40) {
                        const before = getDetailedProgress()[storyId]?.step4 || 0;
                        updateStep4Progress(storyId, 1);
                        const after = getDetailedProgress()[storyId]?.step4 || 0;
                        if (after > before) {
                            renderProgressCard();
                        }
                    }
                }
            } else {
                // Step 1 模式：检查故事内容是否滚动到底部
                const content = document.getElementById('story-content');
                if (!content) return;
                const rect = content.getBoundingClientRect();
                if (rect.bottom - window.innerHeight <= 40) {
                    const before = getDetailedProgress()[storyId]?.step1 || 0;
                    updateStep1Progress(storyId, 1);
                    const after = getDetailedProgress()[storyId]?.step1 || 0;
                    if (after > before) {
                        renderProgressCard();
                    }
                }
            }
        }

        function renderProgressCard() {
            const percentageEl = document.getElementById('progress-percentage');
            const barEl = document.getElementById('progress-bar');
            const stepsEl = document.getElementById('progress-steps');
            const cardEl = document.getElementById('progress-card');

            const detailData = getProgressDetailSnapshot();
            if (!detailData) return;

            const totalPercent = Math.round((detailData.totalProgress || 0) * 100);

            if (percentageEl) {
                percentageEl.textContent = `${totalPercent}%`;
            }
            if (barEl) {
                barEl.style.width = `${totalPercent}%`;
            }
            if (stepsEl) {
                const totalWords = detailData.totalWords || 0;
                const stepMarkup = [
                    { label: 'Step 1', value: detailData.step1 },
                    { label: 'Step 2', value: detailData.step2, extra: totalWords ? `${detailData.step2ClickedCount}/${totalWords}` : '' },
                    { label: 'Step 3', value: detailData.step3, extra: totalWords ? `${detailData.step3ClickedCount}/${totalWords}` : '' },
                    { label: 'Step 4', value: detailData.step4 }
                ].map(step => {
                    const percent = Math.round(Math.min(step.value || 0, 1) * 100);
                    const completedClass = percent >= 100 ? 'completed' : '';
                    const extraLine = step.extra ? `<div class="progress-step-extra">${step.extra}</div>` : '';
                    return `
                        <div class="progress-step ${completedClass}">
                            <div class="progress-step-label">${step.label}</div>
                            <div class="progress-step-value">${percent}%</div>
                            ${extraLine}
                        </div>
                    `;
                }).join('');
                stepsEl.innerHTML = stepMarkup;
            }
            if (cardEl) {
                cardEl.style.display = 'block';
            }
        }

        function getProgressDetailSnapshot() {
            const detailed = getDetailedProgress()[storyId] || {};
            const total = getStoryProgress(storyId);
            const step2Info = detailed.step2 || {};
            const step3Info = detailed.step3 || {};
            const totalWords = totalClickableWords || document.querySelectorAll('.word-unit').length || Math.max(step2Info.clickedWords?.length || 0, step3Info.clickedWords?.length || 0);
            return {
                storyId,
                totalProgress: total,
                step1: detailed.step1 || 0,
                step2: step2Info.progress || 0,
                step3: step3Info.progress || 0,
                step4: detailed.step4 || 0,
                step2ClickedCount: step2Info.clickedWords?.length || 0,
                step3ClickedCount: step3Info.clickedWords?.length || 0,
                totalWords: totalWords
            };
        }

        function speakWord(word) {
            if (!word || !('speechSynthesis' in window)) {
                return;
            }

            ensureVoicesReady();
            window.speechSynthesis.cancel();

            setTimeout(() => {
                speakWordActual(word);
            }, 80);
        }

        function speakWordActual(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.rate = 0.92;
            utterance.pitch = 1.05;
            utterance.volume = 1;

            const voice = getBestEnglishVoice();
            if (voice) {
                utterance.voice = voice;
            }

            window.speechSynthesis.speak(utterance);
        }

        function ensureVoicesReady() {
            if (!('speechSynthesis' in window)) return;
            if (!cachedVoices.length) {
                cachedVoices = window.speechSynthesis.getVoices();
            }
            if (!speechEngineWarmed && cachedVoices.length) {
                warmupSpeechEngine();
            }
        }

        function getBestEnglishVoice() {
            if (!('speechSynthesis' in window)) return null;
            if (!cachedVoices.length) {
                cachedVoices = window.speechSynthesis.getVoices();
            }
            if (!cachedVoices.length) return null;

            const englishVoices = cachedVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));
            const candidates = englishVoices.filter(v => !VOICE_BLACKLIST.some(keyword => v.name.includes(keyword)));
            const usableVoices = candidates.length ? candidates : englishVoices;

            const matchByPriority = (localOnly) => {
                for (const keyword of VOICE_PRIORITY_KEYWORDS) {
                    const voice = usableVoices.find(v => v.name.toLowerCase().includes(keyword.toLowerCase()) && (!localOnly || v.localService));
                    if (voice) return voice;
                }
                return null;
            };

            const preferredLocal = matchByPriority(true);
            if (preferredLocal) return preferredLocal;

            const preferredAny = matchByPriority(false);
            if (preferredAny) return preferredAny;

            const usVoice = usableVoices.find(v => v.lang && v.lang.toLowerCase().startsWith('en-us'));
            if (usVoice) return usVoice;

            const localFallback = usableVoices.find(v => v.localService);
            if (localFallback) return localFallback;

            return usableVoices[0] || null;
        }

        function warmupSpeechEngine() {
            if (!('speechSynthesis' in window) || speechEngineWarmed) return;
            speechEngineWarmed = true;
            const warmup = new SpeechSynthesisUtterance('.');
            warmup.lang = 'en-US';
            warmup.volume = 0;
            warmup.rate = 10;
            warmup.pitch = 1;

            const voice = getBestEnglishVoice();
            if (voice) {
                warmup.voice = voice;
            }

            try {
                window.speechSynthesis.speak(warmup);
            } catch (error) {
                console.warn('语音预热失败:', error);
                speechEngineWarmed = false;
            }
        }

        function getStoryId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id') || '';
        }

        function initializeWordProgressState() {
            const step2Clicked = new Set(getClickedWords(storyId, 'step2'));
            const step3Clicked = new Set(getClickedWords(storyId, 'step3'));

            document.querySelectorAll('.word-unit').forEach(wordEl => {
                const wordId = wordEl.dataset.wordId;
                if (!wordId) {
                    return;
                }
                if (step2Clicked.has(wordId)) {
                    wordEl.dataset.step2Clicked = 'true';
                }
                if (step3Clicked.has(wordId)) {
                    wordEl.dataset.step3Clicked = 'true';
                }
            });
        }

        function applyStoredWordHighlights(mode) {
            if (mode !== 'step2' && mode !== 'step3') {
                return;
            }
            const attribute = mode === 'step2' ? 'step2Clicked' : 'step3Clicked';
            document.querySelectorAll('.word-unit').forEach(wordEl => {
                if (wordEl.dataset[attribute] === 'true') {
                    wordEl.classList.add('show-hidden');
                }
            });
        }

    </script>
    <footer class="site-footer">
        <p>© 2025 @kylin的小世界. All Rights Reserved.</p>
    </footer>
</body>
</html>

